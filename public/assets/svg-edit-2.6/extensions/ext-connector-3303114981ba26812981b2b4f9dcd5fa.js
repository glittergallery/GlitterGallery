svgEditor.addExtension("Connector",function(t){function e(t,e){var a=!!e.getAttribute("marker-"+t),n=5*e.getAttribute("stroke-width");return a?n:0}function a(t){var e=$("#connector_rules");e.length||(e=$('<style id="connector_rules"></style>').appendTo("head")),e.text(t?"#tool_clone, #tool_topath, #tool_angle, #xy_panel { display: none !important; }":""),$("#connector_panel").toggle(t)}function n(t,e,a,r,s){var o=t.points,i=b.createSVGPoint();i.x=a,i.y=r,"end"===e&&(e=o.numberOfItems-1);try{o.replaceItem(i,e)}catch(c){for(var v=t.getAttribute("points").split(" "),l=0;l<v.length;l++)l==e&&(v[l]=a+","+r);t.setAttribute("points",v.join(" "))}if(s){var d=o.getItem(0),g=o.getItem(o.numberOfItems-1);n(t,1,(g.x+d.x)/2,(g.y+d.y)/2)}}function r(t,a){for(var r=k.length;r--;){var s=k[r],o=s.connector,c=(s.elem,s.is_start?"start":"end"),v=elData(o,c+"_bb");v.x=s.start_x+t,v.y=s.start_y+a,elData(o,c+"_bb",v);var l=s.is_start?"end":"start",d=elData(o,l+"_bb"),g=d.x+d.width/2,u=d.y+d.height/2,m=i(g,u,v,e(c,o));n(o,s.is_start?0:"end",m.x,m.y,!0);var f=i(m.x,m.y,elData(o,l+"_bb"),e(l,o));n(o,s.is_start?"end":0,f.x,f.y,!0)}}function s(t){t||(t=S);var e=$(f).find(A);k=[],e.each(function(){for(var e=elData(this,"c_start"),a=elData(this,"c_end"),n=[_(e),_(a)],r=0;2>r;r++){var s=n[r],o=!1;if($(s).parents().each(function(){-1!==$.inArray(this,t)&&(o=!0)}),s&&s.parentNode){if(-1!==$.inArray(s,t)||o){var i=svgCanvas.getStrokedBBox([s]);k.push({elem:s,connector:this,is_start:0===r,start_x:i.x,start_y:i.y})}}else $(this).remove()}})}function o(t){if(s(t),k.length)for(var a=k.length;a--;){var r=k[a],o=r.connector,c=r.elem,v=(5*o.getAttribute("stroke-width"),r.is_start?"start":"end"),l=svgCanvas.getStrokedBBox([c]);l.x=r.start_x,l.y=r.start_y,elData(o,v+"_bb",l);var d=(elData(o,v+"_off"),r.is_start?"end":"start"),g=elData(o,d+"_bb"),u=g.x+g.width/2,m=g.y+g.height/2,f=i(u,m,l,e(v,o));n(o,r.is_start?0:"end",f.x,f.y,!0);var b=i(f.x,f.y,elData(o,d+"_bb"),e(d,o));if(n(o,r.is_start?"end":0,b.x,b.y,!0),-1!=navigator.userAgent.indexOf("AppleWebKit")){for(var h=o.points,_=h.numberOfItems,y=Array(_),p=0;_>p;p++){var f=h.getItem(p);y[p]=f.x+","+f.y}o.setAttribute("points",y.join(" "))}}}function i(t,e,a,n){n&&(n-=0,a=$.extend({},a),a.width+=n,a.height+=n,a.x-=n/2,a.y-=n/2);var r,s=a.x+a.width/2,o=a.y+a.height/2,i=t-s,c=e-o,v=Math.abs(c/i);return r=v<a.height/a.width?a.width/2/Math.abs(i):a.height/2/Math.abs(c),{x:s+i*r,y:o+c*r}}function c(){$(f).find("*").each(function(){var t=this.getAttributeNS(m,"connector");if(t){this.setAttribute("class",A.substr(1));var e=t.split(" "),a=svgCanvas.getStrokedBBox([_(e[0])]),n=svgCanvas.getStrokedBBox([_(e[1])]);$(this).data("c_start",e[0]).data("c_end",e[1]).data("start_bb",a).data("end_bb",n),svgCanvas.getEditorNS(!0)}})}var v,l,d,g,u,m,f=t.svgcontent,b=t.svgroot,h=t.getNextId,_=t.getElem,y=t.addSvgElementFromJson,p=t.selectorManager,x=svgEditor.curConfig,C=!1,k=[],A=".se_connector",S=[];elData=$.data;var w={en:[{id:"mode_connect",title:"Connect two objects"}],fr:[{id:"mode_connect",title:"Connecter deux objets"}]};return function(){var t=svgCanvas.groupSelectedElements;svgCanvas.groupSelectedElements=function(){return svgCanvas.removeFromSelection($(A).toArray()),t.apply(this,arguments)};var e=svgCanvas.moveSelectedElements;svgCanvas.moveSelectedElements=function(){svgCanvas.removeFromSelection($(A).toArray());var t=e.apply(this,arguments);return o(),t},m=svgCanvas.getEditorNS()}(),{name:"Connector",svgicons:"/assets/svg-edit-2.6/images/conn.svg",buttons:[{id:"mode_connect",type:"mode",icon:"/assets/svg-edit-2.6/images/cut.png",title:"Connect two objects",includeWith:{button:"#tool_line",isDefault:!1,position:1},events:{click:function(){svgCanvas.setMode("connector")}}}],addLangData:function(t){return{data:w[t]}},mouseDown:function(t){var e=t.event;v=t.start_x,l=t.start_y;var a=svgCanvas.getMode();if("connector"==a){if(C)return;var n=e.target,r=$(n).parents();if(-1!=$.inArray(f,r)){var o=$(n).closest("foreignObject");g=o.length?o[0]:n;var i=svgCanvas.getStrokedBBox([g]),c=i.x+i.width/2,u=i.y+i.height/2;C=!0,d=y({element:"polyline",attr:{id:h(),points:c+","+u+" "+c+","+u+" "+v+","+l,stroke:"#"+x.initStroke.color,"stroke-width":g.stroke_width&&0!=g.stroke_width?g.stroke_width:x.initStroke.width,fill:"none",opacity:x.initStroke.opacity,style:"pointer-events:none"}}),elData(d,"start_bb",i)}return{started:!0}}"select"==a&&s()},mouseMove:function(t){var a=svgCanvas.getZoom(),s=(t.event,t.mouse_x/a),o=t.mouse_y/a,c=s-v,g=o-l,u=svgCanvas.getMode();if("connector"==u&&C){var m=(3*d.getAttribute("stroke-width"),i(s,o,elData(d,"start_bb"),e("start",d)));v=m.x,l=m.y,n(d,0,m.x,m.y,!0),n(d,"end",s,o,!0)}else if("select"==u){for(var f=S.length;f--;){var b=S[f];b&&elData(b,"c_start")&&(svgCanvas.removeFromSelection([b]),svgCanvas.getTransformList(b).clear())}k.length&&r(c,g)}},mouseUp:function(t){var a=svgCanvas.getZoom(),r=t.event,s=(t.mouse_x/a,t.mouse_y/a,r.target);if("connector"==svgCanvas.getMode()){var o=$(s).closest("foreignObject");o.length&&(s=o[0]);var c=$(s).parents();if(s==g)return C=!0,{keep:!0,element:null,started:C};if(-1===$.inArray(f,c))return $(d).remove(),C=!1,{keep:!1,element:null,started:C};u=s;var b=g.id,h=u.id,_=b+" "+h,y=h+" "+b,x=$(f).find(A).filter(function(){var t=this.getAttributeNS(m,"connector");return t==_||t==y?!0:void 0});if(x.length)return $(d).remove(),{keep:!1,element:null,started:!1};var k=svgCanvas.getStrokedBBox([u]),S=i(v,l,k,e("start",d));return n(d,"end",S.x,S.y,!0),$(d).data("c_start",b).data("c_end",h).data("end_bb",k),m=svgCanvas.getEditorNS(!0),d.setAttributeNS(m,"se:connector",_),d.setAttribute("class",A.substr(1)),d.setAttribute("opacity",1),svgCanvas.addToSelection([d]),svgCanvas.moveToBottomSelectedElement(),p.requestSelector(d).showGrips(!1),C=!1,{keep:!0,element:d,started:C}}},selectedChanged:function(t){if($(f).find(A).length){"connector"==svgCanvas.getMode()&&svgCanvas.setMode("select"),S=t.elems;for(var e=S.length;e--;){var n=S[e];n&&elData(n,"c_start")?(p.requestSelector(n).showGrips(!1),t.selectedElement&&!t.multiselected?a(!0):a(!1)):a(!1)}o()}},elementChanged:function(t){var e=t.elems[0];if(e&&"svg"==e.tagName&&"svgcontent"==e.id&&(f=e,c()),e&&(e.getAttribute("marker-start")||e.getAttribute("marker-mid")||e.getAttribute("marker-end"))){var a=e.getAttribute("marker-start"),n=e.getAttribute("marker-mid"),r=e.getAttribute("marker-end");if(d=e,$(e).data("start_off",!!a).data("end_off",!!r),"line"==e.tagName&&n){var s=e.getAttribute("x1")-0,i=e.getAttribute("x2")-0,v=e.getAttribute("y1")-0,l=e.getAttribute("y2")-0,g=e.id,u=" "+(s+i)/2+","+(v+l)/2+" ",m=y({element:"polyline",attr:{points:s+","+v+u+i+","+l,stroke:e.getAttribute("stroke"),"stroke-width":e.getAttribute("stroke-width"),"marker-mid":n,fill:"none",opacity:e.getAttribute("opacity")||1}});$(e).after(m).remove(),svgCanvas.clearSelection(),m.id=g,svgCanvas.addToSelection([m]),e=m}}if(e.getAttribute("class")==A.substr(1)){var a=_(elData(e,"c_start"));o([a])}else o()},toolButtonStateUpdate:function(t){t.nostroke&&$("#mode_connect").hasClass("tool_button_current")&&clickSelect(),$("#mode_connect").toggleClass("disabled",t.nostroke)}}});