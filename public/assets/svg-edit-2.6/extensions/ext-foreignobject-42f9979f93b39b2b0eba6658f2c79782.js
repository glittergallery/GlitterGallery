svgEditor.addExtension("foreignObject",function(e){function t(e){var t=$("#fc_rules");t.length||(t=$('<style id="fc_rules"></style>').appendTo("head")),t.text(e?" #tool_topath { display: none !important; }":""),$("#foreignObject_panel").toggle(e)}function n(e){$("#tool_source_save, #tool_source_cancel").toggle(!e),$("#foreign_save, #foreign_cancel").toggle(e)}function o(t){var n=a[0];try{var o=Utils.text2xml('<svg xmlns="'+c+'" xmlns:xlink="'+g+'">'+t+"</svg>");e.sanitizeSvg(o.documentElement),n.parentNode.replaceChild(u.importNode(o.documentElement.firstChild,!0),n),e.call("changed",[n]),svgCanvas.clearSelection()}catch(i){return console.log(i),!1}return!0}function i(){var t=a[0];if(t&&!f){f=!0,n(!0),t.removeAttribute("fill");var o=e.svgToString(t,0);$("#svg_source_textarea").val(o),$("#svg_source_editor").fadeIn(),h(),$("#svg_source_textarea").focus()}}function r(t,n){svgCanvas.changeSelectedAttribute(t,n),e.call("changed",a)}var a,l,s,c=(e.svgcontent,e.addSvgElementFromJson,"http://www.w3.org/2000/svg"),g="http://www.w3.org/1999/xlink",d="http://www.w3.org/2000/xmlns/",v="http://www.w3.org/1998/Math/MathML",f=!1,u=e.svgroot.parentNode.ownerDocument,h=function(){var e=$("#svg_source_container").height()-80;$("#svg_source_textarea").css("height",e)};return{name:"foreignObject",svgicons:"/assets/svg-edit-2.6/extensions/foreignobject-icons.xml",buttons:[{id:"tool_foreign",type:"mode",title:"Foreign Object Tool",events:{click:function(){svgCanvas.setMode("foreign")}}},{id:"edit_foreign",type:"context",panel:"foreignObject_panel",title:"Edit ForeignObject Content",events:{click:function(){i()}}}],context_tools:[{type:"input",panel:"foreignObject_panel",title:"Change foreignObject's width",id:"foreign_width",label:"w",size:3,events:{change:function(){r("width",this.value)}}},{type:"input",panel:"foreignObject_panel",title:"Change foreignObject's height",id:"foreign_height",label:"h",events:{change:function(){r("height",this.value)}}},{type:"input",panel:"foreignObject_panel",title:"Change foreignObject's font size",id:"foreign_font_size",label:"font-size",size:2,defval:16,events:{change:function(){r("font-size",this.value)}}}],callback:function(){$("#foreignObject_panel").hide();var e=function(){$("#svg_source_editor").hide(),f=!1,$("#svg_source_textarea").blur(),n(!1)};setTimeout(function(){$("#tool_source_save").clone().hide().attr("id","foreign_save").unbind().appendTo("#tool_source_back").click(function(){f&&(o($("#svg_source_textarea").val())?e():$.confirm("Errors found. Revert to original?",function(t){return t?(e(),void 0):!1}))}),$("#tool_source_cancel").clone().hide().attr("id","foreign_cancel").unbind().appendTo("#tool_source_back").click(function(){e()})},3e3)},mouseDown:function(t){t.event;if("foreign"==svgCanvas.getMode()){l=!0,s=e.addSvgElementFromJson({element:"foreignObject",attr:{x:t.start_x,y:t.start_y,id:e.getNextId(),"font-size":16,width:"48",height:"20",style:"pointer-events:inherit"}});var n=u.createElementNS(v,"math");n.setAttributeNS(d,"xmlns",v),n.setAttribute("display","inline");var o=u.createElementNS(v,"mi");o.setAttribute("mathvariant","normal"),o.textContent="Φ";var i=u.createElementNS(v,"mo");i.textContent="∪";var r=u.createElementNS(v,"mi");return r.textContent="ℳ",n.appendChild(o),n.appendChild(i),n.appendChild(r),s.appendChild(n),{started:!0}}},mouseUp:function(e){e.event;if("foreign"==svgCanvas.getMode()&&l){var t=$(s).attr(["width","height"]);return keep=0!=t.width||0!=t.height,svgCanvas.addToSelection([s],!0),{keep:keep,element:s}}},selectedChanged:function(e){a=e.elems;for(var n=a.length;n--;){var o=a[n];o&&"foreignObject"==o.tagName?e.selectedElement&&!e.multiselected?($("#foreign_font_size").val(o.getAttribute("font-size")),$("#foreign_width").val(o.getAttribute("width")),$("#foreign_height").val(o.getAttribute("height")),t(!0)):t(!1):t(!1)}},elementChanged:function(e){e.elems[0]}}});