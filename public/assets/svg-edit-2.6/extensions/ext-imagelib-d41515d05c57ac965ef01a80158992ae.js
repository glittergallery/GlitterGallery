svgEditor.addExtension("imagelib",function(){function e(){$("#imgbrowse_holder").hide()}function i(e){var i=svgCanvas.addSvgElementFromJson({element:"image",attr:{x:0,y:0,width:0,height:0,id:svgCanvas.getNextId(),style:"pointer-events:inherit"}});svgCanvas.clearSelection(),svgCanvas.addToSelection([i]),svgCanvas.setImageURL(e)}function t(e){$("#lib_framewrap, #imglib_opts").css({right:e?200:10}),p||(p=$("<div id=imglib_preview>").css({position:"absolute",top:45,right:10,width:180,bottom:45,background:"#fff",overflow:"auto"}).insertAfter("#lib_framewrap"),g=$("<button disabled>Import selected</button>").appendTo("#imgbrowse").on("click touchend",function(){$.each(n,function(e){var t=this[0],o=this[1];"svg"==t?svgCanvas.importSvgString(o):i(o),svgCanvas.moveSelectedElements(20*e,20*e,!1)}),p.empty(),n=[],$("#imgbrowse_holder").hide()}).css({position:"absolute",bottom:10,right:-10})),p.toggle(e),g.toggle(e)}function o(){var e=$("#imgbrowse");if(e.length)$("#imgbrowse_holder").show();else{$("<div id=imgbrowse_holder><div id=imgbrowse class=toolbar_button>			</div></div>").insertAfter("#svg_docprops"),e=$("#imgbrowse");{var i=a.imagelib.select_lib,o=$("<ul id=imglib_opts>").appendTo(e),n=$("<iframe/>").prependTo(e).hide().wrap("<div id=lib_framewrap>"),l=$("<h1>").prependTo(e).text(i).css({position:"absolute",top:0,left:0,width:"100%"}),d=$("<button>"+a.common.cancel+"</button>").appendTo(e).on("click touchend",function(){$("#imgbrowse_holder").hide()}).css({position:"absolute",top:5,right:-10}),p=$("<span>").css({position:"absolute",top:5,left:10}).appendTo(e),g=$("<button hidden>"+a.imagelib.show_list+"</button>").appendTo(p).on("click touchend",function(){n.attr("src","about:blank").hide(),o.show(),l.text(i),g.hide()}).css({"margin-right":5}).hide();$("<select><option value=s>"+a.imagelib.import_single+"</option><option value=m>"+a.imagelib.import_multi+"</option><option value=o>"+a.imagelib.open+"</option></select>").appendTo(p).change(function(){switch(r=$(this).val()){case"s":case"o":t(!1);break;case"m":t(!0)}}).css({"margin-top":10})}d.prepend($.getSvgIcon("cancel",!0)),g.prepend($.getSvgIcon("tool_imagelib",!0)),$.each(s,function(e,i){$("<li>").appendTo(o).text(i.name).on("click touchend",function(){n.attr("src",i.url).show(),l.text(i.name),o.hide(),g.show()}).append("<span>"+i.description+"</span>")})}}var a=svgEditor.uiStrings;$.extend(a,{imagelib:{select_lib:"Select an image library",show_list:"Show library list",import_single:"Import single",import_multi:"Import multiple",open:"Open as new document"}});var s=[{name:"IAN Symbol Libraries",url:"http://ian.umces.edu/symbols/catalog/svgedit/album_chooser.php",description:"Free library of illustrations"}],r="s",n=[],l=!1,d={};window.addEventListener("message",function(t){var o=t.data;if(o){var s,m,c=o.charAt(0);if("{"!=c&&l)return l=!1,void 0;if("|"==c){var b=o.indexOf("|",1),v=o.substr(1,b-1);o=o.substr(b+1),c=o.charAt(0)}switch($("#dialog_box").hide(),c){case"{":l=!1;var h=JSON.parse(o);d[h.id]=h;var u=h.name||"file",f=a.notification.retrieving.replace("%s",u);if("m"!=r)$.process_cancel(f,function(){l=!0,$("#dialog_box").hide()});else{var w=$("<div>"+f+"</div>").data("id",h.id);p.append(w),h.entry=w}return;case"<":s=!0;break;case"d":if(0===o.indexOf("data:image/svg+xml")){var x="data:image/svg+xml;base64,",_=o.substring(x.length);o=svgCanvas.Utils.decode64(_),s=!0;break}if(0===o.indexOf("data:image/")){m=!0;break}default:return"m"!==r?e():d[v].entry.remove(),void 0}switch(r){case"s":s?svgCanvas.importSvgString(o):m&&i(o),e();break;case"m":n.push([s?"svg":"img",o]);var h=d[v];if(s){if(h&&h.name)var k=h.name;else var S=(new DOMParser).parseFromString(o,"text/xml").documentElement,k=$(S).children("title").first().text()||"(SVG #"+o.length+")";h?p.children().each(function(){$(this).data("id")==v&&(h.preview_url?$(this).html('<img src="'+h.preview_url+'">'+k):$(this).text(k),g.removeAttr("disabled"))}):(p.append("<div>"+k+"</div>"),g.removeAttr("disabled"))}else{if(h&&h.preview_url)var k=h.name||"";if(h&&h.preview_url)var w='<img src="'+h.preview_url+'">'+k;else var w='<img src="'+o+'">';h?p.children().each(function(){$(this).data("id")==v&&($(this).html(w),g.removeAttr("disabled"))}):(p.append($("<div>").append(w)),g.removeAttr("disabled"))}break;case"o":if(!s)break;svgEditor.openPrep(function(e){e&&(svgCanvas.clear(),svgCanvas.setSvgString(o))}),e()}}},!0);var p,g;return{svgicons:"/assets/svg-edit-2.6/extensions/ext-imagelib.xml",buttons:[{id:"tool_imagelib",type:"app_menu",position:4,title:"Image library",events:{mouseup:o}}],callback:function(){$("<style>").text("				#imgbrowse_holder {					position: absolute;					top: 0;					left: 0;					width: 100%;					height: 100%;					background-color: rgba(0, 0, 0, .5);					z-index: 5;				}								#imgbrowse {					position: absolute;					top: 25px;					left: 25px;					right: 25px;					bottom: 25px;					min-width: 300px;					min-height: 200px;					background: #B0B0B0;					border: 1px outset #777;				}				#imgbrowse h1 {					font-size: 20px;					margin: .4em;					text-align: center;				}				#lib_framewrap,				#imgbrowse > ul {					position: absolute;					top: 45px;					left: 10px;					right: 10px;					bottom: 10px;					background: white;					margin: 0;					padding: 0;				}				#imgbrowse > ul {					overflow: auto;				}				#imgbrowse > div {					border: 1px solid #666;				}				#imglib_preview > div {					padding: 5px;					font-size: 12px;				}				#imglib_preview img {					display: block;					margin: 0 auto;					max-height: 100px;				}				#imgbrowse li {					list-style: none;					padding: .5em;					background: #E8E8E8;					border-bottom: 1px solid #B0B0B0;					line-height: 1.2em;					font-style: sans-serif;					}				#imgbrowse li > span {					color: #666;					font-size: 15px;					display: block;					}				#imgbrowse li:hover {					background: #FFC;					cursor: pointer;					}				#imgbrowse iframe {					width: 100%;					height: 100%;					border: 0;				}			").appendTo("head")}}});