svgEditor.addExtension("Markers",function(t){function e(e,r){var a=e.getAttribute(r);if(!a)return null;var i=a.match(/\(\#(.*)\)/);return i&&2===i.length?t.getElem(i[1]):null}function r(t){if($("#marker_panel").toggle(t),t){var r,a,i=k[0];$.each(p,function(t,n){var l=e(i,"marker-"+n),s=$("#"+n+"_marker");if(l){if(!l.attributes.se_type)return;r="\\"+l.attributes.se_type.textContent,a=r,"\\textmarker"==r?r=l.lastChild.textContent:s.hide()}else r="\\nomarker",a=r,s.hide();s.val(r),d(n,a)})}}function a(e,r){var a="#ffffff",i="none",n=0,l=t.getElem(e);if(!l&&""!=r&&"\\nomarker"!=r){var s=k[0],o=s.getAttribute("stroke"),d=50,m=50,u="0 0 100 100",c=5,h=5,p=10;if(se_type="\\"==r.substr(0,1)?r.substr(1):"textmarker",_[se_type]){if(l=g({element:"marker",attr:{id:e,markerUnits:"strokeWidth",orient:"auto",style:"pointer-events:none",se_type:se_type}}),"textmarker"!=se_type){var f=g(_[se_type]),v=o;"_o"==se_type.substr(-2)&&(v="none"),f.setAttribute("fill",v),f.setAttribute("stroke",o),f.setAttribute("stroke-width",p),l.appendChild(f)}else{var b=g(_[se_type]);b.textContent=r;var A=b.getBBox(),y=1,x=A;x.x=0,x.y=0,x.width+=2*y,x.height+=2*y,b.setAttribute("x",y),b.setAttribute("y",x.height-y-A.height/4),b.setAttribute("fill",o),d=x.width/2+y,m=x.height/2+y,u=x.x+" "+x.y+" "+x.width+" "+x.height,c=x.width/10,h=x.height/10;var w=g({element:"rect",attr:{x:x.x,y:x.y,width:x.width,height:x.height,fill:a,stroke:i,"stroke-width":n}});l.setAttribute("orient",0),l.appendChild(w),l.appendChild(b)}return l.setAttribute("viewBox",u),l.setAttribute("markerWidth",c),l.setAttribute("markerHeight",h),l.setAttribute("refX",d),l.setAttribute("refY",m),t.findDefs().appendChild(l),l}}}function i(){var r={start_marker:"start",mid_marker:"mid",end_marker:"end"},i=r[this.id],l="marker-"+i,s=this.value,o=k[0],m=e(o,l);if(m&&$(m).remove(),o.removeAttribute(l),""==s&&(s="\\nomarker"),"\\nomarker"==s)return d(i,s),t.call("changed",k),void 0;var u=f+i+"_"+o.id;a(u,s),svgCanvas.changeSelectedAttribute(l,"url(#"+u+")"),"line"==o.tagName&&"mid"==i&&(o=n(o)),t.call("changed",k),d(i,s)}function n(e){if("line"!=e.tagName)return e;var r=e.getAttribute("x1")-0,a=e.getAttribute("x2")-0,i=e.getAttribute("y1")-0,n=e.getAttribute("y2")-0,l=e.id,s=" "+(r+a)/2+","+(i+n)/2+" ",o=g({element:"polyline",attr:{points:r+","+i+s+a+","+n,stroke:e.getAttribute("stroke"),"stroke-width":e.getAttribute("stroke-width"),fill:"none",opacity:e.getAttribute("opacity")||1}});$.each(p,function(t,r){var a="marker-"+r,i=e.getAttribute(a);i&&o.setAttribute(a,e.getAttribute(a))});var d=new t.BatchCommand;return d.addSubCommand(new t.RemoveElementCommand(e,e.parentNode)),d.addSubCommand(new t.InsertElementCommand(o)),$(e).after(o).remove(),svgCanvas.clearSelection(),o.id=l,svgCanvas.addToSelection([o]),t.addCommandToHistory(d),o}function l(t){var r=t.getAttribute("stroke");$.each(p,function(a,i){var n=e(t,"marker-"+i);if(n&&n.attributes.se_type){var l=n.lastElementChild;if(l){var s=l.getAttribute("fill"),o=l.getAttribute("stroke");s&&"none"!=s&&l.setAttribute("fill",r),o&&"none"!=o&&l.setAttribute("stroke",r)}}})}function s(r){$.each(p,function(i,l){var s=f+l+"_"+r.id,o="marker-"+l,d=e(r,o);if(d&&d.attributes.se_type){var m=r.getAttribute(o);if(m){var u=r.id.length,c=m.substr(-u-1,u);if(r.id!=c){var h=$("#"+l+"_marker").attr("value");a(s,h),svgCanvas.changeSelectedAttribute(o,"url(#"+s+")"),"line"==r.tagName&&"mid"==l&&(r=n(r)),t.call("changed",k)}}}})}function o(t,e){$("#"+t+"_marker").val(e),$("#"+t+"_marker").change();$("#"+t+"_marker")}function d(t,e){"\\"!=e.substr(0,1)&&(e="\\textmarker");var r="#"+v+t+"_"+e.substr(1);svgEditor.setIcon("#cur_"+t+"_marker_list",$(r).children()),$(r).addClass("current").siblings().removeClass("current")}function m(t){var e=$("#"+t+"_marker").val();"\\"==e.substr(0,1)&&(e=""),$.prompt("Enter text for "+t+" marker",e,function(e){e&&o(t,e)})}function u(){var t=this.id.split("_"),e=t[1],r=t[2];t[3]&&(r+="_"+t[3]),"textmarker"!=r?o(e,"\\"+r):m(e)}function c(t,e){var r=b[t];for(var a in r)if(r[a].id==e)return r[a].title;return e}function h(){var t=[];return $.each(p,function(e,r){var a=r+"_marker_list",i=!0;$.each(_,function(e){var n=c("en",e);t.push({id:v+r+"_"+e,svgicon:e,title:n,type:"context",events:{click:u},panel:"marker_panel",list:a,isDefault:i}),i=!1})}),t}var k,g=(t.svgcontent,t.addSvgElementFromJson),p=["start","mid","end"],f="se_marker_",v="mkr_",_={nomarker:{},leftarrow:{element:"path",attr:{d:"M0,50 L100,90 L70,50 L100,10 Z"}},rightarrow:{element:"path",attr:{d:"M100,50 L0,90 L30,50 L0,10 Z"}},textmarker:{element:"text",attr:{x:0,y:0,"stroke-width":0,stroke:"none","font-size":75,"font-family":"serif","text-anchor":"left","xml:space":"preserve"}},forwardslash:{element:"path",attr:{d:"M30,100 L70,0"}},reverseslash:{element:"path",attr:{d:"M30,0 L70,100"}},verticalslash:{element:"path",attr:{d:"M50,0 L50,100"}},box:{element:"path",attr:{d:"M20,20 L20,80 L80,80 L80,20 Z"}},star:{element:"path",attr:{d:"M10,30 L90,30 L20,90 L50,10 L80,90 Z"}},xmark:{element:"path",attr:{d:"M20,80 L80,20 M80,80 L20,20"}},triangle:{element:"path",attr:{d:"M10,80 L50,20 L80,80 Z"}},mcircle:{element:"circle",attr:{r:30,cx:50,cy:50}}},b={en:[{id:"start_marker_list",title:"Select start marker type"},{id:"mid_marker_list",title:"Select mid marker type"},{id:"end_marker_list",title:"Select end marker type"},{id:"nomarker",title:"No Marker"},{id:"leftarrow",title:"Left Arrow"},{id:"rightarrow",title:"Right Arrow"},{id:"textmarker",title:"Text Marker"},{id:"forwardslash",title:"Forward Slash"},{id:"reverseslash",title:"Reverse Slash"},{id:"verticalslash",title:"Vertical Slash"},{id:"box",title:"Box"},{id:"star",title:"Star"},{id:"xmark",title:"X"},{id:"triangle",title:"Triangle"},{id:"mcircle",title:"Circle"},{id:"leftarrow_o",title:"Open Left Arrow"},{id:"rightarrow_o",title:"Open Right Arrow"},{id:"box_o",title:"Open Box"},{id:"star_o",title:"Open Star"},{id:"triangle_o",title:"Open Triangle"},{id:"mcircle_o",title:"Open Circle"}]};return $.each(["leftarrow","rightarrow","box","star","mcircle","triangle"],function(t,e){_[e+"_o"]=_[e]}),{name:"Markers",svgicons:"/assets/svg-edit-2.6/extensions/markers-icons.xml",buttons:h(),context_tools:[{type:"input",panel:"marker_panel",title:"Start marker",id:"start_marker",label:"s",size:3,events:{change:i}},{type:"button-select",panel:"marker_panel",title:c("en","start_marker_list"),id:"start_marker_list",colnum:3,events:{change:u}},{type:"input",panel:"marker_panel",title:"Middle marker",id:"mid_marker",label:"m",defval:"",size:3,events:{change:i}},{type:"button-select",panel:"marker_panel",title:c("en","mid_marker_list"),id:"mid_marker_list",colnum:3,events:{change:u}},{type:"input",panel:"marker_panel",title:"End marker",id:"end_marker",label:"e",size:3,events:{change:i}},{type:"button-select",panel:"marker_panel",title:c("en","end_marker_list"),id:"end_marker_list",colnum:3,events:{change:u}}],callback:function(){$("#marker_panel").addClass("toolset").hide()},addLangData:function(t){return{data:b[t]}},selectedChanged:function(t){k=t.elems;for(var e=k.length,a=["line","path","polyline","polygon"];e--;){var i=k[e];i&&-1!=$.inArray(i.tagName,a)?t.selectedElement&&!t.multiselected?r(!0):r(!1):r(!1)}},elementChanged:function(t){var e=t.elems[0];e&&(e.getAttribute("marker-start")||e.getAttribute("marker-mid")||e.getAttribute("marker-end"))&&(l(e),s(e)),changing_flag=!1}}});